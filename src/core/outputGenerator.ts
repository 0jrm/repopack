import { RepopackConfigMerged } from '../types/index.js';
import * as fs from 'node:fs/promises';
import path from 'node:path';
import { generateTreeString } from '../utils/treeGenerator.js';
import { SanitizedFile } from '../utils/fileHandler.js';

const SEPARATOR = '='.repeat(16);
const LONG_SEPARATOR = '='.repeat(64);

export async function generateOutput(
  rootDir: string,
  config: RepopackConfigMerged,
  sanitizedFiles: SanitizedFile[],
  fsModule = fs,
): Promise<void> {
  const output: string[] = [];

  // Generate and add the header
  const header = generateFileHeader(config, sanitizedFiles);
  output.push(header);

  // Add sanitized files
  for (const file of sanitizedFiles) {
    output.push(SEPARATOR);
    output.push(`File: ${file.path}`);
    output.push(SEPARATOR);

    if (config.output.showLineNumbers) {
      const lines = file.content.split('\n');
      const numberedLines = lines.map((line, index) => `${(index + 1).toString().padStart(4)}: ${line}`);
      output.push(numberedLines.join('\n'));
    } else {
      output.push(file.content);
    }

    output.push(''); // Add an empty line after each file content
  }

  const outputPath = path.resolve(rootDir, config.output.filePath);
  await fsModule.writeFile(outputPath, output.join('\n'));
}

export function generateFileHeader(config: RepopackConfigMerged, sanitizedFiles: SanitizedFile[]): string {
  const fileTree = generateTreeString(sanitizedFiles.map((file) => file.path));

  const defaultHeader = `${LONG_SEPARATOR}
Repopack Output File
${LONG_SEPARATOR}

This file was generated by Repopack on: ${new Date().toISOString()}

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This header section
2. Multiple file entries, each consisting of:
   a. A separator line (${SEPARATOR})
   b. The file path (File: path/to/file)
   c. Another separator line
   d. The full contents of the file
   e. A blank line

Usage Guidelines:
-----------------
1. This file should be treated as read-only. Any changes should be made to the
   original repository files, not this packed version.
2. When processing this file, use the separators and "File:" markers to
   distinguish between different files in the repository.
3. Be aware that this file may contain sensitive information. Handle it with
   the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repopack's
  configuration.
- Binary files are not included in this packed representation.
${config.output.removeComments ? '- Code comments have been removed.\n' : ''}
${config.output.showLineNumbers ? '- Line numbers have been added to the beginning of each line.\n' : ''}

For more information about Repopack, visit: https://github.com/yamadashy/repopack
`;

  let headerText = defaultHeader;

  if (config.output?.headerText) {
    headerText += `
Additional User-Provided Header:
--------------------------------
${config.output.headerText}
`;
  }

  headerText += `
${LONG_SEPARATOR}
Repository Structure
${LONG_SEPARATOR}
${fileTree}
`;

  headerText += `
${LONG_SEPARATOR}
Repository Files
${LONG_SEPARATOR}
`;

  return headerText;
}
